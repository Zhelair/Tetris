<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Protest Tetris</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
      color: #fff;
      background:
        linear-gradient(rgba(0, 0, 0, 0.65), rgba(0, 0, 0, 0.85)),
        url("sofia.png") center/cover no-repeat fixed;
      background-color: #050813;
    }

    .wrapper {
      display: flex;
      flex-direction: row;
      gap: 16px;
      align-items: flex-start;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
      max-width: 100%;
    }

    #game {
      background: transparent;
      border: 2px solid #555;
      max-width: 100%;
    }

    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 190px;
    }

    button {
      padding: 8px 10px;
      font-size: 14px;
      border: none;
      cursor: pointer;
      background: #ffcc00;
      color: #000;
      border-radius: 8px;
    }

    button:hover {
      filter: brightness(1.1);
    }

    .touch-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .touch-controls button {
      flex: 1 1 30%;
      padding: 10px;
      font-size: 18px;
      border-radius: 8px;
    }

    @media (max-width: 700px) {
      .wrapper {
        flex-direction: column;
        align-items: center;
      }
      .side-panel {
        width: 100%;
        align-items: stretch;
      }
      #game {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <canvas id="game"></canvas>

    <div class="side-panel">
      <div>
        <span style="font-weight:bold;font-size:16px;">Corruption cleared:</span>
        <div id="score" style="margin-top:4px;font-size:18px;">0</div>
      </div>

      <button id="restart">Restart</button>
      <button id="pause">Pause</button>
      <button id="toggleMusic">Play music</button>

      <div style="font-size:12px;opacity:0.9;max-width:190px;">
        ← → move, ↓ drop, ↑ rotate, Space = hard drop
      </div>

      <div class="touch-controls">
        <button data-action="left">◀</button>
        <button data-action="down">⬇</button>
        <button data-action="right">▶</button>
        <button data-action="rotate">⟳</button>
        <button data-action="drop">⤓</button>
      </div>
    </div>
  </div>

  <audio id="bgm" src="music.mp3" loop></audio>

  <script>
    // ===== CONFIG =====
    const COLS = 10;
    const ROWS = 20;
    const BLOCK = 32;     // <--- YOUR NEW SIZE
    const SPEED = 500;

    // Multiple Boiko images
    const boikoImages = [];
    ["boiko.png", "boiko_1.png", "boiko_2.png"].forEach(src => {
      const img = new Image();
      img.src = src;
      boikoImages.push(img);
    });

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    canvas.width = COLS * BLOCK;
    canvas.height = ROWS * BLOCK;

    const scoreEl = document.getElementById("score");
    const bgm = document.getElementById("bgm");
    const toggleMusicBtn = document.getElementById("toggleMusic");
    const restartBtn = document.getElementById("restart");
    const pauseBtn = document.getElementById("pause");
    const touchButtons = document.querySelectorAll(".touch-controls button");

    let musicPlaying = false;
    let board;
    let currentPiece;
    let gameOver;
    let score;
    let lastTick;
    let popups = [];
    let paused = false;

    const SHAPES = [
      {cells:[[0,0],[-1,0],[1,0],[2,0]]},
      {cells:[[0,0],[0,1],[1,0],[1,1]]},
      {cells:[[0,0],[-1,0],[1,0],[0,1]]},
      {cells:[[0,0],[0,1],[0,2],[1,2]]},
      {cells:[[0,0],[0,1],[0,2],[-1,2]]},
      {cells:[[0,0],[1,0],[0,1],[-1,1]]},
      {cells:[[0,0],[-1,0],[0,1],[1,1]]}
    ];

    function emptyBoard() {
      return Array.from({length: ROWS}, () => Array(COLS).fill(null));
    }

    function rotate([x,y]) { return [y,-x]; }
    function rotateShape(cells) { return cells.map(rotate); }

    function spawnPiece() {
      const shape = SHAPES[Math.floor(Math.random() * SHAPES.length)];
      const imgIndex = Math.floor(Math.random() * boikoImages.length);
      return {
        x: Math.floor(COLS/2),
        y: 0,
        cells: shape.cells.map(c=>[...c]),
        imgIndex
      }
    }

    function valid(piece, dx=0, dy=0, newCells=null) {
      const cells = newCells || piece.cells;
      for (const [cx,cy] of cells) {
        let x = piece.x + cx + dx;
        let y = piece.y + cy + dy;
        if (x < 0 || x >= COLS || y < 0 || y >= ROWS) return false;
        if (board[y][x]) return false;
      }
      return true;
    }

    function merge(piece) {
      for (const [cx,cy] of piece.cells) {
        board[piece.y+cy][piece.x+cx] = { imgIndex: piece.imgIndex };
      }
    }

    function addPopup(text,row) {
      popups.push({ x:1.5, y:row, text, life:60 });
    }

    function clearLines() {
      for (let r=ROWS-1; r>=0; r--) {
        if (board[r].every(c=>c!==null)) {
          board.splice(r,1);
          board.unshift(new Array(COLS).fill(null));
          score += 100;
          scoreEl.textContent = score;
          addPopup("CORRUPTION -1", r);
          r++;
        }
      }
    }

    // ≡ Bulgarian flag inside canvas
    function drawFlagBackground() {
      const stripeHeight = canvas.height/3;
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,canvas.width,stripeHeight);

      ctx.fillStyle = "#00966E";
      ctx.fillRect(0,stripeHeight,canvas.width,stripeHeight);

      ctx.fillStyle = "#d62612";
      ctx.fillRect(0,2*stripeHeight,canvas.width,stripeHeight);
    }

    function drawCell(x,y,cell) {
      const px = x*BLOCK, py = y*BLOCK;
      const img = boikoImages[cell.imgIndex];
      if (img.complete && img.naturalWidth > 0) {
        ctx.drawImage(img, px, py, BLOCK, BLOCK);
      }
    }

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawFlagBackground();

      for (let r=0;r<ROWS;r++)
        for (let c=0;c<COLS;c++)
          if (board[r][c]) drawCell(c,r,board[r][c]);

      if (currentPiece && !gameOver) {
        for (const [cx,cy] of currentPiece.cells)
          drawCell(currentPiece.x+cx,currentPiece.y+cy,{imgIndex:currentPiece.imgIndex});
      }

      popups.forEach(p=>{
        ctx.font="16px Arial";
        ctx.lineWidth=3;

        let sx=p.x*BLOCK;
        let sy=p.y*BLOCK+BLOCK/2;

        ctx.strokeStyle="#000";
        ctx.strokeText(p.text,sx,sy);
        ctx.fillStyle="#ffea00";
        ctx.fillText(p.text,sx,sy);

        p.y -= 0.03;
        p.life--;
      });

      popups = popups.filter(p=>p.life>0);

      if (gameOver) {
        ctx.fillStyle="rgba(0,0,0,0.8)";
        ctx.fillRect(0,canvas.height/2-60,canvas.width,120);

        ctx.fillStyle="#ffea00";
        ctx.font="32px Arial";
        ctx.textAlign="center";
        ctx.fillText("Оставка!", canvas.width/2, canvas.height/2-5);

        ctx.fillStyle="#ffffff";
        ctx.font="16px Arial";
        ctx.fillText("Натисни Restart.", canvas.width/2, canvas.height/2+25);
      }

      if (paused && !gameOver) {
        ctx.fillStyle="rgba(0,0,0,0.6)";
        ctx.fillRect(0,canvas.height/2-40,canvas.width,80);

        ctx.fillStyle="#ffcc00";
        ctx.font="24px Arial";
        ctx.fillText("Пауза", canvas.width/2, canvas.height/2+5);
      }
    }

    function stepDown() {
      if (valid(currentPiece,0,1)) currentPiece.y++;
      else {
        merge(currentPiece);
        clearLines();
        currentPiece = spawnPiece();
        if (!valid(currentPiece)) gameOver=true;
      }
    }

    function update(t) {
      if (!lastTick) lastTick = t;

      if (!paused && !gameOver && t-lastTick > SPEED) {
        stepDown();
        lastTick = t;
      }

      draw();
      requestAnimationFrame(update);
    }

    function handleAction(a) {
      if (gameOver || paused) return;
      if (a==="left" && valid(currentPiece,-1,0)) currentPiece.x--;
      if (a==="right" && valid(currentPiece,1,0)) currentPiece.x++;
      if (a==="down" && valid(currentPiece,0,1)) currentPiece.y++;
      if (a==="rotate") {
        const rot = rotateShape(currentPiece.cells);
        if (valid(currentPiece,0,0,rot)) currentPiece.cells=rot;
      }
      if (a==="drop") {
        while (valid(currentPiece,0,1)) currentPiece.y++;
        stepDown();
      }
      draw();
    }

    document.addEventListener("keydown",(e)=>{
      if(e.code==="ArrowLeft")handleAction("left");
      if(e.code==="ArrowRight")handleAction("right");
      if(e.code==="ArrowDown")handleAction("down");
      if(e.code==="ArrowUp")handleAction("rotate");
      if(e.code==="Space"){e.preventDefault();handleAction("drop");}
    });

    touchButtons.forEach(b=>{
      b.onclick=()=>handleAction(b.dataset.action);
    });

    pauseBtn.onclick=function(){
      if(gameOver)return;
      paused=!paused;
      pauseBtn.textContent=paused?"Resume":"Pause";
      if(!paused) lastTick=performance.now();
      draw();
    };

    restartBtn.onclick=init;

    toggleMusicBtn.onclick=function(){
      if(!musicPlaying){
        bgm.play().then(()=>{
          musicPlaying=true;
          toggleMusicBtn.textContent="Pause music";
        }).catch(()=>{});
      } else {
        bgm.pause();
        musicPlaying=false;
        toggleMusicBtn.textContent="Play music";
      }
    };

    function init() {
      board = emptyBoard();
      currentPiece = spawnPiece();
      score = 0;
      gameOver = false;
      paused = false;
      scoreEl.textContent=0;
      pauseBtn.textContent="Pause";
      lastTick=0;
      popups=[];
      draw();
    }

    init();
    requestAnimationFrame(update);
  </script>
</body>
</html>
